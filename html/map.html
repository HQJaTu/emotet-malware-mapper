<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Emotet Malware map</title>
    <link rel="stylesheet" href="map.css">
</head>
<script src="map_config.js" type="text/javascript"></script>
<script src="jquery-3.4.1.min.js" type="text/javascript"></script>
<body>

    <div id="floating-panel">
        <div id="floating-panel-header-box">
            <h2>Emotet banking trojan</h2>
            <span>[<a href="https://www.malwarebytes.com/emotet/" target="_blank">1</a>],
            [<a href="https://en.wikipedia.org/wiki/Emotet" target="_blank">2</a>]</span>
        </div>
    </div>

    <div id="map"></div>
<script type="text/javascript">
    let map, heatmaps;
    let googleMapsScriptIsInjected = false;

    initMap = () => {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 3,
            center: {lat: 0.0, lng: 0.0},
            mapTypeId: 'satellite'
        });

        var epoch;
        const floatingPanel = $('#floating-panel');
        floatingPanel.append(`<h3>Toggle</h3>`);
        heatmaps = {};
        [...Array(3).keys()].forEach(epoch => {
            floatingPanel.append(`<h4>Epoch ${epoch + 1}</h4>`);
            heatmaps[epoch + 1] = {};
            ['C2', 'Download link'].forEach(category => {
                getPointsAndCreate(epoch + 1, category, createHeatmap);
                floatingPanel.append(`<input type="checkbox" onclick="toggleHeatmap(${epoch + 1}, '${category}');" checked="true" />&nbsp;${category}<br/>`);
            });
        });
    };

    createHeatmap = (epoch, category, dataPoints) => {
        heatmaps[epoch][category] = new google.maps.visualization.HeatmapLayer({
            data: dataPoints,
            radius: 25,
            dissapating: false,
            map: map
        });
    };

    toggleHeatmap = (epoch, category) => {
        heatmaps[epoch][category].setMap(heatmaps[epoch][category].getMap() ? null : map);
    };

    injectGoogleMapsApiScript = (options) => {
        if (googleMapsScriptIsInjected) {
            throw new Error('Google Maps Api is already loaded.');
        }

        const optionsQuery = Object.keys(options)
            .map(k => `${encodeURIComponent(k)}=${encodeURIComponent(options[k])}`)
            .join('&');

        const url = `https://maps.googleapis.com/maps/api/js?${optionsQuery}`;

        const script = document.createElement('script');

        script.setAttribute('src', url);
        script.setAttribute('async', '');
        script.setAttribute('defer', '');

        document.head.appendChild(script);

        googleMapsScriptIsInjected = true;
    };

    $(document).ready(function() {
        gMapConfig['callback'] = 'initMap';
        injectGoogleMapsApiScript(gMapConfig);
    });
</script>

<script async defer src="map_data.js" type="text/javascript"></script>
</body>
</html>